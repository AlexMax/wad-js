<html>
    <head>
        <title>wad js test</title>
        <script type="text/javascript" src="http://code.jquery.com/jquery-1.11.0.min.js"></script>
        <style>
            #preview {
            position: fixed;
            }
        </style>
    </head>
    <body>
        <input type="file" id="fileInput">
        <script type="text/javascript" src="wad.js"></script>
        <br>
        <table><tr><td valign="top"><div id="lumpList"></div></td><td valign="top"><div id="preview"></td></tr></table>
        <script>
            
            var self = this;
            var lumpnames = ["a","b","c"];
            var fileInput = document.getElementById('fileInput');
            var fileDisplayArea = document.getElementById('test');
            var lumpList = null;
            
            function makeUL(array) {
                // Create the list element:
                var list = document.createElement('ol');
                list.id = "lumpUL";

                for(var i = 0; i < array.length; i++) {
                    // Create the list item:
                    var item = document.createElement('li');

                    // Set its contents:
                    item.appendChild(document.createTextNode(array[i]));

                    // Add it to the list:
                    list.appendChild(item);
                }

                // Finally, return the constructed list:
                return list;
            }

            fileInput.addEventListener('change', function(e) {
                
                if (self.lumpList) self.lumpList.destructor();
                self.lumpnames = [];
            
                var file = fileInput.files[0];
                
                wad = Object.create(Wad);
                
                wad.onLoad = function(e) {
                    for (var i = 0; i < wad.lumps.length; i++) {
                        self.lumpnames.push("[" + wad.detectLumpType(i) + "]" + wad.lumps[i].name);
                    }
                    
                    $('#lumpList').html(makeUL(self.lumpnames));
                    
                    $('#lumpUL').delegate('li', 'click', function (e) {
                        var li = e.target,
                            i = 0;

                        while ( li.previousElementSibling ) {
                            li = li.previousElementSibling;
                            i += 1;   
                        }
                        
                        lumptype = wad.detectLumpType(i);
                        
                        switch (lumptype) {
                            
                            case TEXT:
                                $('#preview').html(wad.getLumpAsText(i));
                                break;
                            case "PLAYPAL":
                                playpal = Object.create(Playpal);
                                playpal.load(wad.getLump(i));
                                $("#preview").html("");
                                document.getElementById("preview").appendChild(playpal.toCanvas());
                                break;
                            case "COLORMAP":
                                colormap = Object.create(Colormap);
                                colormap.load(wad.getLump(i));
                                $("#preview").html("");
                                document.getElementById("preview").appendChild(colormap.toCanvas(wad));
                                break;
                            case FLAT:
                                flat = Object.create(Flat);
                                flat.load(wad.getLump(i));
                                $("#preview").html("");
                                document.getElementById("preview").appendChild(flat.toCanvas(wad));
                                break;
                            case GRAPHIC:
                                graphic = Object.create(Graphic);
                                graphic.load(wad.getLump(i));
                                $("#preview").html("");
                                document.getElementById("preview").appendChild(graphic.toCanvas(wad));
                                break;
                            case "...":
                                $('#preview').html("Unable to preview this lump, and can't detect it's type");
                                break;
                            default:
                                $('#preview').html("Unable to preview "+lumptype+" lumps");
                                break;
                        
                        }
                    });
                };
                
                wad.load(file);
            });
            
            
        
            
        
        </script>
        
    </body>
</html>